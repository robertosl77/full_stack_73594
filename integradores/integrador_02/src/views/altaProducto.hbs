{{!-- src/views/altaProducto.hbs --}}

<div class="container mt-2">
  <h2 class="mb-4">Alta de Producto</h2>

    {{#if errorImagen}}
    <!-- Modal -->
    <div class="modal fade show" id="errorModal" tabindex="-1" style="display: block;" aria-modal="true" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Error al guardar producto</h5>
            <button type="button" class="btn-close" onclick="cerrarModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>{{errorImagen}}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function cerrarModal() {
        const modal = document.getElementById('errorModal');
        modal.style.display = 'none';
        modal.classList.remove('show');
      }
    </script>
    {{/if}}

  <form action="{{basedir}}/alta" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="nombre" class="form-label">Nombre del producto</label>
      <input type="text" class="form-control" id="nombre" name="nombre" required>
      <div id="nombreErrorAlert" class="alert alert-danger mt-2" style="display: none;">
        El nombre del producto ya existe.
      </div>      
    </div>

    <div class="mb-3">
      <label for="imagen" class="form-label">Imagen del producto</label>
      <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*" required>
      <div id="imageErrorAlert" class="alert alert-danger mt-2" style="display: none;">
        Solo se permiten archivos de imagen.
      </div>      
    </div>

    <div class="mb-3">
      <label for="bodega" class="form-label">Bodega</label>
      <input type="text" class="form-control" id="bodega" name="bodega" required>
    </div>

    <div class="mb-3">
      <label for="tipo" class="form-label">Tipo</label>
      <input type="text" class="form-control" id="tipo" name="tipo" required>
    </div>

    <div class="mb-3">
      <label for="precio" class="form-label">Precio</label>
      <input type="number" class="form-control" id="precio_original" name="precio_original" step="0.01" required>
    </div>

    <div class="mb-3">
      <label for="descuento" class="form-label">Descuento (%)</label>
      <input type="number" class="form-control" id="descuento" name="descuento" min="0" max="100" value="0">
    </div>

    <div class="mb-3">
      <label for="stock" class="form-label">Stock disponible</label>
      <input type="number" class="form-control" id="stock" name="stock" min="0" value="0">
    </div>

    <button type="submit" class="btn btn-success">Guardar producto</button>
  </form>
</div>

<script>
  document.getElementById('imagen').addEventListener('change', function (event) {
    const file = event.target.files[0];
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    const alertBox = document.getElementById('imageErrorAlert');

    if (file && !allowedTypes.includes(file.type)) {
      alertBox.style.display = 'block';
      event.target.value = ''; // Limpia el input
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 3000);
    } else {
      alertBox.style.display = 'none'; // Oculta si todo est√° bien
    }
  });
</script>

<script>
  const nombresExistentes = {{{nombresExistentes}}};
  const inputNombre = document.getElementById('nombre');
  const alertaNombre = document.getElementById('nombreErrorAlert');
  let nombreTimer = null;

  inputNombre.addEventListener('input', function () {
    const valor = inputNombre.value.trim().toLowerCase();
    const existe = nombresExistentes.includes(valor);

    if (existe) {
      alertaNombre.style.display = 'block';

      clearTimeout(nombreTimer); // Reinicia si sigue escribiendo
      nombreTimer = setTimeout(() => {
        alertaNombre.style.display = 'none';
      }, 3000);
    } else {
      alertaNombre.style.display = 'none';
      clearTimeout(nombreTimer);
    }
  });
</script>
